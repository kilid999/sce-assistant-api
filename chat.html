<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø³Ø§Ø¹Ø¯ - SCE</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg0:#ffffff;
      --bg1:#f7f3ff;
      --bg2:#f6f7fb;

      --text:#0f172a;
      --muted:#64748b;
      --muted2:#94a3b8;

      --border:#e7eaf1;
      --shadow: 0 18px 60px rgba(15, 23, 42, 0.10);

      --p:#6d5efc;
      --p2:#a78bfa;

      --radius: 22px;
      --tap: 44px;

      --card:#fff;
      --chip:#fff;
      --chipHover:#fafbff;
      --msgAssist:#fff;
      --msgUserText:#fff;
      --footer:#fff;

      --success:#16a34a;
      --danger:#ef4444;
    }

    /* ===== Dark mode (auto on mobile) ===== */
    @media (prefers-color-scheme: dark){
      :root{
        --bg0:#0b1020;
        --bg1:#0b1020;
        --bg2:#0b1020;

        --text:#e5e7eb;
        --muted:#9aa4b2;
        --muted2:#7b8794;

        --border:#1f2937;
        --shadow: 0 18px 60px rgba(0, 0, 0, 0.35);

        --card:#0f172a;
        --chip:#0f172a;
        --chipHover:#111c33;
        --msgAssist:#0f172a;
        --footer:#0f172a;
      }
      body{
        background: radial-gradient(1100px 700px at 50% 10%, #101a33 0, #0b1020 55%, #0b1020 100%);
      }
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; padding:0; }
    body{
      font-family:"Tajawal", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(1100px 700px at 50% 10%, var(--bg1) 0%, var(--bg0) 55%, var(--bg2) 100%);
      color: var(--text);
    }

    .page{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .app{
      width:100%;
      max-width:480px;
      min-height:720px;
      max-height:860px;
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
    }

    /* ===== Topbar ===== */
    .topbar{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-bottom:1px solid var(--border);
      background: var(--card);
      flex: 0 0 auto;
    }

    .tb-spacer{ width: var(--tap); height: var(--tap); }

    .tb-center{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      justify-content:center;
      flex: 1;
    }

    /* Ø´Ø¹Ø§Ø± Ù…Ø³ØªØ·ÙŠÙ„ */
    .brand-icon{
      width: 68px;
      height: 32px;
      border-radius: 10px;
      background: transparent;
      border: 1px solid rgba(109,94,252,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .brand-icon img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      opacity:.98;
    }

    .brand-title{
      font-weight: 900;
      font-size: 16px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .tb-btn{
      width: var(--tap);
      height: var(--tap);
      border: 0;
      background: transparent;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 14px;
      transition: background .15s ease, transform .12s ease;
      color: var(--text);
    }
    .tb-btn:hover{ background: rgba(148,163,184,0.12); }
    .tb-btn:active{ transform: translateY(1px); }

    .icon-menu{
      width: 20px;
      height: 14px;
      display:block;
      position: relative;
    }
    .icon-menu span,
    .icon-menu::before,
    .icon-menu::after{
      content:"";
      position:absolute;
      left:0;
      right:0;
      height:2px;
      background: currentColor;
      border-radius: 2px;
      opacity:.9;
    }
    .icon-menu span{ top: 6px; }
    .icon-menu::before{ top: 0; }
    .icon-menu::after{ bottom: 0; }

    /* ===== Chat ===== */
    .chat{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      background: radial-gradient(900px 520px at 50% 0%, rgba(246,242,255,.95) 0%, rgba(255,255,255,.92) 58%, rgba(247,248,251,.95) 100%);
    }
    @media (prefers-color-scheme: dark){
      .chat{
        background: radial-gradient(900px 520px at 50% 0%, rgba(16,26,51,.85) 0%, rgba(11,16,32,.92) 58%, rgba(11,16,32,.95) 100%);
      }
    }

    .chat-body{
      flex:1;
      min-height:0;
      overflow:auto;
      overflow-x:hidden;
      padding: 14px 14px 10px;
      scrollbar-width:none;
      scroll-behavior:smooth;
      -webkit-overflow-scrolling:touch;
    }
    .chat-body::-webkit-scrollbar{ display:none; }

    /* Ù†Ø®Ù„ÙŠ Ù…Ø³Ø§Ø­Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ø¹Ø´Ø§Ù† Ù…Ø§ ØªÙ†Ø­Ø¬Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø®Ù„Ù Ø§Ù„Ø´Ø±ÙŠØ·+Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    .chat-body.has-dock{
      padding-bottom: 190px; /* Ø´Ø±ÙŠØ· Ø§Ø®ØªØµØ§Ø±Ø§Øª + Ø¥Ø¯Ø®Ø§Ù„ + Ù‡ÙˆÙŠØ© */
    }

    /* ===== Home banner ===== */
    .home-banner{
      padding: 18px 8px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
    }

    .orb{
      width: 86px; height:86px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 25%,
        #ffffff 0%,
        #f5e7ff 20%,
        #b9a5ff 45%,
        #7c5cff 70%,
        #4c34e6 100%);
      box-shadow:
        0 0 0 12px rgba(109,94,252,0.08),
        0 22px 60px rgba(76, 52, 230, 0.22);
      position:relative;
      animation: orbFloat 3.8s ease-in-out infinite;
      margin-top: 6px;
      flex: 0 0 auto;
    }
    @media (prefers-color-scheme: dark){
      .orb{
        box-shadow:
          0 0 0 12px rgba(109,94,252,0.16),
          0 22px 60px rgba(109, 94, 252, 0.22);
      }
    }
    .orb::after{
      content:"";
      position:absolute;
      left:0; right:0;
      margin:auto;
      bottom:-18px;
      width: 78px; height: 20px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(15,23,42,0.22), transparent 68%);
      filter: blur(2px);
      opacity: .35;
      transform: scale(.9);
    }

    .home-title{
      font-size: 18px;
      font-weight: 900;
      text-align:center;
      margin-top: 6px;
    }

    /* ===== Messages ===== */
    .message-group{
      margin-bottom: 10px;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }

    .msg{
      max-width: 86%;
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 13px;
      line-height: 1.7;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .msg.user{
      align-self:flex-end;
      background: linear-gradient(135deg, var(--p), var(--p2));
      color: var(--msgUserText);
      border-bottom-left-radius: 6px;
    }

    .msg.assistant{
      align-self:flex-start;
      background: var(--msgAssist);
      border:1px solid var(--border);
      box-shadow: 0 10px 30px rgba(15,23,42,0.05);
      border-bottom-right-radius: 6px;
    }
/* ===== Loading bubble with orb ===== */
.loading-bubble{
  display:flex;
  align-items:center;
  gap: 10px;
}

.loading-orb{
  width: 34px;
  height: 34px;
  border-radius: 999px;
  background: radial-gradient(circle at 30% 25%,
    #ffffff 0%,
    #f5e7ff 20%,
    #b9a5ff 45%,
    #7c5cff 70%,
    #4c34e6 100%);
  box-shadow:
    0 0 0 6px rgba(109,94,252,0.10),
    0 10px 22px rgba(76, 52, 230, 0.18);
  animation: orbFloat 1.8s ease-in-out infinite;
  flex: 0 0 auto;
}

.loading-text{
  color: var(--muted);
  font-size: 12.5px;
  line-height: 1.5;
}
    /* ===== Meta + Actions under assistant message ===== */
    .msg-meta{
      font-size: 11px;
      color: var(--muted2);
      display:flex;
      align-items:center;
      gap: 6px;
      margin: 0 4px;
    }

    .msg-actions{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 2px;
      margin-inline: 4px;
    }

    .msg-action-btn{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--chip);
      color: var(--muted);
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap: 6px;
      font-size: 12px;
      transition: background .15s ease, border-color .15s ease, transform .12s ease;
      user-select:none;
    }
    .msg-action-btn:hover{
      background: var(--chipHover);
      border-color: rgba(109,94,252,.22);
      transform: translateY(-1px);
    }
    .msg-action-btn:active{ transform: translateY(1px); }
    .msg-action-btn[disabled]{ opacity:.5; cursor:default; transform:none; }

    .pill-ok{ border-color: rgba(22,163,74,.35) !important; color: var(--success) !important; }
    .pill-bad{ border-color: rgba(239,68,68,.35) !important; color: var(--danger) !important; }

    /* ===== Dock (Ø§Ù„Ø´Ø±ÙŠØ· + Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„) Ø«Ø§Ø¨Øª ØªØ­Øª ===== */
    .dock{
      flex: 0 0 auto;
      border-top: 1px solid var(--border);
      background: var(--footer);
    }

    .quick-actions{
      padding: 10px 10px 6px;
      border-bottom: 1px solid rgba(148,163,184,0.18);
      background: linear-gradient(to top, rgba(255,255,255,0.92), rgba(255,255,255,0.70));
    }
    @media (prefers-color-scheme: dark){
      .quick-actions{
        background: linear-gradient(to top, rgba(15,23,42,0.96), rgba(15,23,42,0.75));
        border-bottom: 1px solid rgba(148,163,184,0.12);
      }
    }

    .suggest-row{
      width:100%;
      display:flex;
      gap: 10px;
      justify-content:flex-start;
      overflow-x:auto;
      padding: 6px 2px 2px;
      scrollbar-width:none;
    }
    .suggest-row::-webkit-scrollbar{ display:none; }

    .suggest-btn{
      flex: 0 0 auto;
      border:1px solid var(--border);
      background: var(--chip);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12.5px;
      color: var(--text);
      cursor:pointer;
      min-width: 150px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.04);
      transition: transform .12s ease, background .15s ease, border-color .15s ease;
      white-space: nowrap;
    }
    .suggest-btn:hover{
      background: var(--chipHover);
      border-color: rgba(109,94,252,.22);
      transform: translateY(-1px);
    }
    .suggest-btn:active{ transform: translateY(1px); }

    /* ===== Footer / Input ===== */
    .chat-footer{
      padding: 10px 12px 12px;
      background: var(--footer);
    }

    .input-shell{ position:relative; width:100%; }

    .chat-input{
      width:100%;
      resize:none;
      min-height: 46px;
      max-height: 110px;
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 12px 14px 12px 56px;
      outline:none;
      font-family: inherit;
      font-size: 13px;
      line-height: 1.6;
      background: var(--card);
      color: var(--text);
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .chat-input::placeholder{ color:#9aa4b2; }

    .state-default .chat-input{ box-shadow:none; }
    .state-enabled .chat-input{
      border-color: rgba(109,94,252,0.45);
      box-shadow: 0 0 0 3px rgba(109,94,252,0.12);
    }
    .state-filled .chat-input{
      border-color: rgba(109,94,252,0.55);
      box-shadow: 0 0 0 3px rgba(109,94,252,0.10);
    }

    .send-in{
      position:absolute;
      left: 10px;
      bottom: 8px;
      width: 38px;
      height: 38px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--p), var(--p2));
      box-shadow: 0 12px 28px rgba(109,94,252,0.28);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .12s ease, opacity .15s ease, box-shadow .15s ease;
    }
    .send-in:active{ transform: translateY(1px) scale(.98); box-shadow: 0 8px 20px rgba(109,94,252,0.20); }
    .send-in.disabled{ opacity: .35; cursor: default; box-shadow:none; }

    .arrow-up{
      width: 18px; height: 18px;
      position: relative;
      transform: translateY(-1px);
    }
    .arrow-up::before{
      content:"";
      position:absolute;
      left: 50%;
      top: 3px;
      width: 2px;
      height: 12px;
      background:#fff;
      transform: translateX(-50%);
      border-radius: 2px;
    }
    .arrow-up::after{
      content:"";
      position:absolute;
      left: 50%;
      top: 2px;
      width: 10px;
      height: 10px;
      border-top: 2px solid #fff;
      border-left: 2px solid #fff;
      transform: translateX(-50%) rotate(45deg);
      border-radius: 2px;
    }

    .brand-strip{
      text-align:center;
      padding: 8px 12px 12px;
      font-size: 11px;
      color: var(--muted2);
      background: var(--footer);
    }

    /* ===== Drawer (History) ===== */
    .drawer{
      position:absolute;
      inset:0;
      background: var(--card);
      transform: translateX(100%);
      transition: transform .22s ease;
      display:flex;
      flex-direction:column;
      z-index: 50;
    }
    .drawer.open{ transform: translateX(0); }

    .drawer-top{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-bottom:1px solid var(--border);
      background: var(--card);
      flex: 0 0 auto;
      gap: 8px;
    }

    .drawer-title{
      font-weight: 900;
      font-size: 16px;
      flex:1;
      text-align:center;
    }

    .new-chat{
      border:1px solid var(--border);
      background: var(--chip);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-size: 12px;
      color: var(--text);
      box-shadow: 0 10px 30px rgba(15,23,42,0.04);
      transition: transform .12s ease, background .15s ease, border-color .15s ease;
      white-space: nowrap;
    }
    .new-chat:hover{ background: var(--chipHover); border-color: rgba(109,94,252,.22); transform: translateY(-1px); }
    .new-chat:active{ transform: translateY(1px); }

    .hist{
      flex:1;
      min-height:0;
      overflow:auto;
      padding: 12px 12px 16px;
      background: radial-gradient(900px 520px at 50% 0%, rgba(246,242,255,.95) 0%, rgba(255,255,255,.92) 58%, rgba(247,248,251,.95) 100%);
      scrollbar-width:none;
    }
    @media (prefers-color-scheme: dark){
      .hist{
        background: radial-gradient(900px 520px at 50% 0%, rgba(16,26,51,.85) 0%, rgba(11,16,32,.92) 58%, rgba(11,16,32,.95) 100%);
      }
    }
    .hist::-webkit-scrollbar{ display:none; }

    .hist-label{
      font-size: 12px;
      color: var(--muted2);
      font-weight: 800;
      margin: 12px 4px 8px;
    }

    .hist-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      background: var(--chip);
      border:1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.04);
      margin-bottom: 10px;
      cursor:pointer;
    }
    .hist-item:hover{ border-color: rgba(109,94,252,.22); background: var(--chipHover); }
    .hist-text{
      flex:1;
      font-size: 13px;
      color: var(--text);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .trash{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      cursor:pointer;
      color: var(--muted);
      transition: background .15s ease, border-color .15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
    }
    .trash:hover{ background: rgba(148,163,184,0.12); border-color: rgba(148,163,184,0.12); }

    .empty-hist{
      margin-top: 40px;
      text-align:center;
      color: var(--muted);
      font-size: 13px;
    }

    @keyframes orbFloat{
      0%{ transform: translateY(0); }
      50%{ transform: translateY(-8px); }
      100%{ transform: translateY(0); }
    }

    @media (max-width: 520px){
      .page{ padding:0; align-items:stretch; }
      .app{
        max-width:none;
        min-height:100vh;
        max-height:none;
        border-radius:0;
        border-left:none;
        border-right:none;
        box-shadow:none;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="app">
      <!-- Topbar -->
      <header class="topbar">
        <div class="tb-spacer" aria-hidden="true"></div>

        <div class="tb-center">
          <div class="brand-icon">
            <img src="sce-logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†" />
          </div>
          <div class="brand-title">Ù…Ø³Ø§Ø¹Ø¯ - SCE</div>
        </div>

        <button class="tb-btn" id="btnMenu" type="button" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
          <span class="icon-menu"><span></span></span>
        </button>
      </header>

      <!-- Single Chat View -->
      <section class="chat" id="chatView">
        <main class="chat-body has-dock" id="chatBody">
          <div class="home-banner" id="homeBanner">
            <div class="orb" aria-hidden="true"></div>
            <div class="home-title">ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>
          </div>

          <div class="message-group" id="welcomeMsg">
            <div class="msg assistant">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹
Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ø¨Ø¯Ø¡.</div>
          </div>
        </main>

        <!-- Dock Ø«Ø§Ø¨Øª ØªØ­Øª: Ø´Ø±ÙŠØ· Ø§Ø®ØªØµØ§Ø±Ø§Øª + Ø¥Ø¯Ø®Ø§Ù„ -->
        <div class="dock">
          <div class="quick-actions" id="quickActions">
            <div class="suggest-row" id="suggestRow">
              <button class="suggest-btn" data-text="Ø£Ø±ØºØ¨ ÙÙŠ Ù…Ø¹Ø±ÙØ© ØªÙØ§ØµÙŠÙ„  Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†">ØªÙØ§ØµÙŠÙ„ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù‡ÙŠØ¦Ø©</button>
              <button class="suggest-btn" data-text="Ù…Ø§ Ù‡ÙŠ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ù‡Ù†ÙŠ Ù„Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†">Ø¢Ù„ÙŠØ© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ù‡Ù†ÙŠ</button>
              <button class="suggest-btn" data-text="Ø£Ø±Ø´Ø¯Ù†ÙŠ Ø¥Ù„Ù‰ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù‡Ù†ÙŠ Ø­Ø³Ø¨ ØªØ®ØµØµÙŠ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ">Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù‡Ù†ÙŠ</button>
              <button class="suggest-btn" data-text="Ø£Ø­ØªØ§Ø¬ Ø´Ø±Ø­Ù‹Ø§ Ù…Ø¨Ø³Ø·Ù‹Ø§ Ø¹Ù† ÙƒÙˆØ¯ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ ÙˆÙ…ØªØ·Ù„Ø¨Ø§ØªÙ‡">ÙƒÙˆØ¯ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ</button>
              <button class="suggest-btn" data-text="Ù…Ø§ Ù‡ÙŠ Ø´Ø±ÙˆØ· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§ØªØ¨ ÙˆØ§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© Ù„Ø¯Ù‰ Ø§Ù„Ù‡ÙŠØ¦Ø©">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§ØªØ¨ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ©</button>
              <button class="suggest-btn" data-text="Ù„Ø¯ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± Ø­ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ© ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‡Ù†ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©">Ø§Ù„Ø¯ÙˆØ±Ø§Øª ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</button>
              <button class="suggest-btn" data-text="Ø£Ø±ØºØ¨ ÙÙŠ Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ¨Ø¹Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©">ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
              <button class="suggest-btn" data-text="Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù„ÙˆØ§Ø¦Ø­ ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ù„Ø¯Ù‰ Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†">Ø§Ù„Ù„ÙˆØ§Ø¦Ø­ ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</button>
            </div>
          </div>

          <footer class="chat-footer">
            <div class="input-shell state-default" id="inputState">
              <textarea id="chatInput" class="chat-input" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."></textarea>
              <button id="sendBtn" class="send-in disabled" type="button" aria-label="Ø¥Ø±Ø³Ø§Ù„">
                <span class="arrow-up"></span>
              </button>
            </div>
          </footer>

          <div class="brand-strip">Ù…Ø¯Ø¹ÙˆÙ… Ù…Ù† Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ÙˆØ·Ù†ÙŠ Ù„Ù„ØªÙØªÙŠØ´ ÙˆØ§Ù„Ø±Ù‚Ø§Ø¨Ø©</div>
        </div>
      </section>

      <!-- History Drawer -->
      <aside class="drawer" id="historyDrawer" aria-label="Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª">
        <div class="drawer-top">
          <button class="tb-btn" id="btnCloseDrawer" type="button" aria-label="Ø±Ø¬ÙˆØ¹">â†</button>
          <div class="drawer-title">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>
          <button class="new-chat" id="btnNewChat" type="button">Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        </div>

        <div class="hist" id="historyList"></div>
        <div class="brand-strip">Ù…Ø¯Ø¹ÙˆÙ… Ù…Ù† Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ÙˆØ·Ù†ÙŠ Ù„Ù„ØªÙØªÙŠØ´ ÙˆØ§Ù„Ø±Ù‚Ø§Ø¨Ø©</div>
      </aside>
    </div>
  </div>

  <script>
    const API_URL = "/api/chat";
    const LS_KEY = "nasim_conversations";
    const LS_ACTIVE = "nasim_active_conversation_id";

    let conversations = loadConversations();
    let activeConvId = localStorage.getItem(LS_ACTIVE) || null;
    let loadingBubble = null;

    const btnMenu = document.getElementById("btnMenu");
    const historyDrawer = document.getElementById("historyDrawer");
    const historyList = document.getElementById("historyList");
    const btnNewChat = document.getElementById("btnNewChat");
    const btnCloseDrawer = document.getElementById("btnCloseDrawer");

    const chatBody = document.getElementById("chatBody");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const inputState = document.getElementById("inputState");
    const suggestRow = document.getElementById("suggestRow");

    const homeBanner = document.getElementById("homeBanner");
    const welcomeMsg = document.getElementById("welcomeMsg");

    function nowISO(){ return new Date().toISOString(); }

    function loadConversations(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }

    function saveConversations(){
      localStorage.setItem(LS_KEY, JSON.stringify(conversations));
    }

    function uuid(){
      return "c_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function scrollToBottom(){
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function setSendEnabled(enabled){
      if(enabled) sendBtn.classList.remove("disabled");
      else sendBtn.classList.add("disabled");
    }

    function setInputVisualState(state){
      inputState.classList.remove("state-default","state-enabled","state-filled");
      inputState.classList.add(state);
    }

    function getActiveConversation(){
      if(!activeConvId) return null;
      return conversations.find(c => c.id === activeConvId) || null;
    }

    function smartTitleFrom(text){
      let s = (text || "").trim();
      s = s.replace(/[ØŸ?!.ØŒØ›:]+/g, " ").replace(/\s+/g, " ").trim();

      const removePrefixes = [
        "ÙƒÙŠÙ", "ÙˆØ´", "Ù…Ø§", "Ù…Ø§Ù‡Ùˆ", "Ù…Ø§ Ù‡Ùˆ", "Ø£Ø¨ÙŠ", "Ø§Ø¨ÙŠ", "Ø£Ø±ÙŠØ¯", "Ø§Ø±ÙŠØ¯",
        "Ù…Ù…ÙƒÙ†", "Ù„Ùˆ Ø³Ù…Ø­Øª", "Ø³Ø§Ø¹Ø¯Ù†ÙŠ", "Ø³Ø§Ø¹Ø¯", "Ø£Ø±Ø´Ø¯Ù†ÙŠ", "Ø§Ø±Ø´Ø¯Ù†ÙŠ",
        "Ø¹Ù†Ø¯ÙŠ", "Ù‡Ù„", "ÙˆÙŠÙ†", "ÙˆØ´ Ù‡ÙŠ", "Ù…Ø§ Ù‡ÙŠ", "Ø§Ø¨ÙŠ Ø§Ø¹Ø±Ù", "Ø£Ø¨ÙŠ Ø£Ø¹Ø±Ù"
      ];

      for(const p of removePrefixes){
        if(s.startsWith(p + " ")){ s = s.slice(p.length).trim(); break; }
      }

      const stop = new Set(["Ø¹Ù†","ÙÙŠ","Ø¹Ù„Ù‰","Ù…Ù†","Ø¥Ù„Ù‰","Ø§Ù„Ù‰","Ù‡Ø°Ø§","Ù‡Ø°Ù‡","Ø°Ù„Ùƒ","ØªÙ„Ùƒ","Ù‡Ùˆ","Ù‡ÙŠ","Ø§Ù†Ø§","Ø£Ù†Ø§","Ù„Ù€","Ø¨Ù€","Ùˆ"]);
      const words = s.split(" ").filter(w => w && !stop.has(w));
      const pick = words.length ? words : (s ? s.split(" ") : []);
      return (pick.slice(0, 5).join(" ") || "Ù…Ø­Ø§Ø¯Ø«Ø©");
    }

    function showHomeBanner(){
      if(homeBanner) homeBanner.style.display = "flex";
      if(welcomeMsg) welcomeMsg.style.display = "block";
    }

    function hideHomeBanner(){
      if(homeBanner) homeBanner.style.display = "none";
      if(welcomeMsg) welcomeMsg.style.display = "none";
    }

    function addAssistantActions(wrapper, text, msgId){
      const meta = document.createElement("div");
      meta.className = "msg-meta";
      meta.innerHTML = `<span>Ø§Ù„Ø¢Ù†</span> Â· <span>SCE</span>`;
      wrapper.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "msg-actions";

      const like = document.createElement("button");
      like.className = "msg-action-btn";
      like.innerHTML = "ğŸ‘ Ø¥Ø¹Ø¬Ø§Ø¨";
      like.addEventListener("click", () => rateMessage(msgId, "up", like));

      const dislike = document.createElement("button");
      dislike.className = "msg-action-btn";
      dislike.innerHTML = "ğŸ‘ ØºÙŠØ± Ù…ÙÙŠØ¯";
      dislike.addEventListener("click", () => rateMessage(msgId, "down", dislike));

      const copyBtn = document.createElement("button");
      copyBtn.className = "msg-action-btn";
      copyBtn.innerHTML = "ğŸ“‹ Ù†Ø³Ø®";
      copyBtn.addEventListener("click", () => copyText(text));

      const shareBtn = document.createElement("button");
      shareBtn.className = "msg-action-btn";
      shareBtn.innerHTML = "ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©";
      shareBtn.addEventListener("click", () => shareText(text));

      actions.appendChild(like);
      actions.appendChild(dislike);
      actions.appendChild(copyBtn);
      actions.appendChild(shareBtn);

      wrapper.appendChild(actions);
    }

    async function copyText(text){
      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text);
        }else{
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.opacity = "0";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }
      }catch(e){}
    }

    async function shareText(text){
      try{
        if(navigator.share){
          await navigator.share({ text });
        }else{
          await copyText(text);
          addMessage("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØµØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø´Ø§Ø±ÙƒØªÙ‡ Ø§Ù„Ø¢Ù†.", "assistant", { system:true });
        }
      }catch(e){}
    }

    function addMessage(text, sender="assistant", opts={}){
      const wrapper = document.createElement("div");
      wrapper.className = "message-group";

      const msg = document.createElement("div");
      msg.className = "msg " + (sender === "user" ? "user" : "assistant");
      msg.innerText = text;
      wrapper.appendChild(msg);

      // ID Ù„Ù„Ø±Ø³Ø§Ù„Ø© (Ù„Ù„ØªÙ‚ÙŠÙŠÙ…)
      const msgId = opts.msgId || ("m_" + Math.random().toString(16).slice(2));

      if(sender === "assistant" && !opts.noActions){
        addAssistantActions(wrapper, text, msgId);
      }

      chatBody.appendChild(wrapper);
      setTimeout(scrollToBottom, 30);

      return { wrapper, msgId };
    }

   function addLoadingBubble(){
  if(loadingBubble) return;

  const group = document.createElement("div");
  group.className = "message-group";

  const msg = document.createElement("div");
  msg.className = "msg assistant";

  msg.innerHTML = `
    <div class="loading-bubble">
      <span class="loading-orb" aria-hidden="true"></span>
      <span class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù„ÙˆØ§Ø¦Ø­ ÙˆØ£Ù†Ø¸Ù…Ø© Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†...</span>
    </div>
  `;

  group.appendChild(msg);
  chatBody.appendChild(group);

  loadingBubble = group;
  setTimeout(scrollToBottom, 20);
}

    function removeLoadingBubble(){
      if(loadingBubble && loadingBubble.parentNode){
        loadingBubble.parentNode.removeChild(loadingBubble);
      }
      loadingBubble = null;
      setTimeout(scrollToBottom, 30);
    }

    function clearRenderedMessagesKeepBanner(){
      const keep = new Set([homeBanner, welcomeMsg]);
      [...chatBody.children].forEach(ch => { if(!keep.has(ch)) ch.remove(); });
    }

    function renderChat(conv){
      clearRenderedMessagesKeepBanner();

      if(!conv || !Array.isArray(conv.messages)) {
        showHomeBanner();
        return;
      }

      if(conv.messages.length > 0) hideHomeBanner();
      else showHomeBanner();

      for(const m of conv.messages){
        const res = addMessage(m.text, m.role, { msgId: m.id, noActions: m.role !== "assistant" ? true : false });
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù„Ø£Ø³ØªØ§Ø°ÙŠØ© â€” Ø£ÙØ¹Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªÙØ¹Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ù€ assistant
      }

      setTimeout(scrollToBottom, 30);
    }

    function isSameDay(d1, d2){
      return d1.getFullYear() === d2.getFullYear()
        && d1.getMonth() === d2.getMonth()
        && d1.getDate() === d2.getDate();
    }

    function groupConversations(){
      const now = new Date();
      const today = [];
      const week = [];
      const sorted = [...conversations].sort((x,y) => (y.updatedAt || "").localeCompare(x.updatedAt || ""));
      for(const c of sorted){
        const t = new Date(c.updatedAt || c.createdAt || nowISO());
        if(isSameDay(t, now)) today.push(c);
        else week.push(c);
      }
      return { today, week };
    }

    function renderHistory(){
      const { today, week } = groupConversations();
      historyList.innerHTML = "";

      if(conversations.length === 0){
        const empty = document.createElement("div");
        empty.className = "empty-hist";
        empty.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯.";
        historyList.appendChild(empty);
        return;
      }

      const makeSection = (label, items) => {
        const lbl = document.createElement("div");
        lbl.className = "hist-label";
        lbl.innerText = label;
        historyList.appendChild(lbl);

        if(items.length === 0){
          const em = document.createElement("div");
          em.className = "empty-hist";
          em.style.marginTop = "10px";
          em.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.";
          historyList.appendChild(em);
          return;
        }

        for(const c of items){
          const row = document.createElement("div");
          row.className = "hist-item";

          if(c.id === activeConvId){
            row.style.borderColor = "rgba(109,94,252,.55)";
          }

          const t = document.createElement("div");
          t.className = "hist-text";
          t.innerText = c.title || "Ù…Ø­Ø§Ø¯Ø«Ø©";
          row.appendChild(t);

          const trash = document.createElement("button");
          trash.className = "trash";
          trash.type = "button";
          trash.setAttribute("aria-label","Ø­Ø°Ù");
          trash.textContent = "ğŸ—‘ï¸";
          row.appendChild(trash);

          row.addEventListener("click", (e) => {
            if(e.target === trash) return;
            activeConvId = c.id;
            localStorage.setItem(LS_ACTIVE, activeConvId);
            closeDrawer();
            renderChat(c);
          });

          trash.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            deleteConversation(c.id);
          });

          historyList.appendChild(row);
        }
      };

      makeSection("Ø§Ù„ÙŠÙˆÙ…", today);
      makeSection("Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ", week);
    }

    function deleteConversation(id){
      conversations = conversations.filter(c => c.id !== id);
      saveConversations();

      if(activeConvId === id){
        activeConvId = null;
        localStorage.removeItem(LS_ACTIVE);
        showHomeBanner();
        clearRenderedMessagesKeepBanner();
      }
      renderHistory();
    }

    function startNewConversation(){
      activeConvId = null;
      localStorage.removeItem(LS_ACTIVE);

      showHomeBanner();
      clearRenderedMessagesKeepBanner();

      chatInput.value = "";
      chatInput.style.height = "46px";
      setSendEnabled(false);
      setInputVisualState("state-default");
    }

    function ensureConversationExists(firstUserText){
      let conv = getActiveConversation();
      if(conv) return conv;

      const id = uuid();
      const createdAt = nowISO();
      conv = {
        id,
        title: smartTitleFrom(firstUserText),
        createdAt,
        updatedAt: createdAt,
        threadId: null,
        messages: [],
        ratings: {} // msgId -> up/down
      };

      conversations.unshift(conv);
      saveConversations();

      activeConvId = id;
      localStorage.setItem(LS_ACTIVE, activeConvId);

      return conv;
    }

    function pushMessageToConv(conv, role, text, id){
      conv.messages.push({ role, text, ts: nowISO(), id });
      conv.updatedAt = nowISO();

      if(!conv.title || conv.title === "Ù…Ø­Ø§Ø¯Ø«Ø©"){
        if(role === "user") conv.title = smartTitleFrom(text);
      }

      saveConversations();
    }

    function rateMessage(msgId, dir, btn){
      const conv = getActiveConversation();
      if(!conv) return;

      conv.ratings = conv.ratings || {};
      conv.ratings[msgId] = dir;
      saveConversations();

      // UI feedback
      btn.classList.add(dir === "up" ? "pill-ok" : "pill-bad");
      btn.disabled = true;

      // Ø¹Ø·Ù‘Ù„ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ ÙƒØ°Ù„Ùƒ
      const group = btn.closest(".message-group");
      if(group){
        const buttons = [...group.querySelectorAll(".msg-action-btn")];
        for(const b of buttons){
          if(b !== btn && (b.textContent.includes("Ø¥Ø¹Ø¬Ø§Ø¨") || b.textContent.includes("ØºÙŠØ± Ù…ÙÙŠØ¯"))){
            b.disabled = true;
          }
        }
      }
    }

    async function callAssistantAPI(conv, userText){
      addLoadingBubble();
      try{
        const resp = await fetch(API_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            message: userText,
            threadId: conv.threadId
          })
        });

        if(!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        conv.threadId = data.threadId || conv.threadId;

        removeLoadingBubble();

        const answer = data.answer || "Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙØªØ§Ø­ answer ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©.";
        const msgId = "a_" + Math.random().toString(16).slice(2);

        addMessage(answer, "assistant", { msgId });
        pushMessageToConv(conv, "assistant", answer, msgId);

        renderHistory();
      }catch(err){
        console.error("API error:", err);
        removeLoadingBubble();

        const msg = "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©.\nØªØ£ÙƒØ¯ Ø£Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ù…ØªØ§Ø­Ø© Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
        const msgId = "e_" + Math.random().toString(16).slice(2);

        addMessage(msg, "assistant", { msgId });
        pushMessageToConv(conv, "assistant", msg, msgId);

        renderHistory();
      }
    }

    function handleSend(){
      const text = chatInput.value.trim();
      if(!text || sendBtn.classList.contains("disabled")) return;

      hideHomeBanner();

      const conv = ensureConversationExists(text);

      const userMsgId = "u_" + Math.random().toString(16).slice(2);
      addMessage(text, "user", { noActions:true, msgId:userMsgId });
      pushMessageToConv(conv, "user", text, userMsgId);

      chatInput.value = "";
      chatInput.style.height = "46px";
      setSendEnabled(false);
      setInputVisualState("state-default");

      renderHistory();
      callAssistantAPI(conv, text);
    }

    function openDrawer(){
      renderHistory();
      historyDrawer.classList.add("open");
    }
    function closeDrawer(){
      historyDrawer.classList.remove("open");
    }

    btnMenu.addEventListener("click", openDrawer);
    btnCloseDrawer.addEventListener("click", closeDrawer);

    historyDrawer.addEventListener("click", (e) => {
      if(e.target === historyDrawer) closeDrawer();
    });

    btnNewChat.addEventListener("click", () => {
      closeDrawer();
      startNewConversation();
    });

    suggestRow.addEventListener("click", (e) => {
      const b = e.target.closest(".suggest-btn");
      if(!b) return;
      const t = b.getAttribute("data-text") || b.innerText;
      chatInput.value = t;
      chatInput.dispatchEvent(new Event("input"));
      chatInput.focus();
      handleSend();
    });

    chatInput.addEventListener("focus", () => {
      setInputVisualState(chatInput.value.trim() ? "state-filled" : "state-enabled");
    });

    chatInput.addEventListener("blur", () => {
      setInputVisualState(chatInput.value.trim() ? "state-filled" : "state-default");
    });

    chatInput.addEventListener("input", () => {
      const has = chatInput.value.trim().length > 0;
      setSendEnabled(has);
      setInputVisualState(has ? "state-filled" : (document.activeElement === chatInput ? "state-enabled" : "state-default"));

      chatInput.style.height = "auto";
      chatInput.style.height = Math.min(chatInput.scrollHeight, 110) + "px";
    });

    chatInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        handleSend();
      }
    });

    sendBtn.addEventListener("click", handleSend);

    window.addEventListener("load", () => {
      setSendEnabled(false);
      setInputVisualState("state-default");

      const conv = getActiveConversation();
      if(conv){
        renderChat(conv);
      }else{
        showHomeBanner();
        clearRenderedMessagesKeepBanner();
      }

      setTimeout(scrollToBottom, 80);
    });
  </script>
</body>
</html>
