<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø³Ø§Ø¹Ø¯ Ù†Ø³ÙŠÙ…</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg0:#ffffff;
      --bg1:#f7f3ff;
      --bg2:#f6f7fb;

      --text:#0f172a;
      --muted:#64748b;
      --muted2:#94a3b8;

      --border:#e7eaf1;
      --shadow: 0 18px 60px rgba(15, 23, 42, 0.10);

      --p:#6d5efc;
      --p2:#a78bfa;

      --radius: 22px;
      --tap: 44px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; padding:0; }
    body{
      font-family:"Tajawal", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(1100px 700px at 50% 10%, var(--bg1) 0%, var(--bg0) 55%, var(--bg2) 100%);
      color: var(--text);
    }

    /* ===== App shell ===== */
    .page{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .app{
      width:100%;
      max-width:480px;
      min-height:720px;
      max-height:860px;
      background: var(--bg0);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
    }

    /* ===== Topbar ===== */
    .topbar{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-bottom:1px solid var(--border);
      background:#fff;
      flex: 0 0 auto;
    }

    .tb-spacer{
      width: var(--tap);
      height: var(--tap);
    }

    .tb-center{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      justify-content:center;
      flex: 1;
    }

    .brand-icon{
      width: 26px;
      height: 26px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(109,94,252,.14), rgba(167,139,250,.18));
      border: 1px solid rgba(109,94,252,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .brand-icon img{
      width: 18px; height:18px;
      object-fit:contain;
      opacity:.95;
    }

    .brand-title{
      font-weight: 900;
      font-size: 16px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .tb-btn{
      width: var(--tap);
      height: var(--tap);
      border: 0;
      background: transparent;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 14px;
      transition: background .15s ease, transform .12s ease;
      color:#334155;
    }
    .tb-btn:hover{ background:#f6f7fb; }
    .tb-btn:active{ transform: translateY(1px); }

    .icon-menu{
      width: 20px;
      height: 14px;
      display:block;
      position: relative;
    }
    .icon-menu span,
    .icon-menu::before,
    .icon-menu::after{
      content:"";
      position:absolute;
      left:0;
      right:0;
      height:2px;
      background: currentColor;
      border-radius: 2px;
      opacity:.9;
    }
    .icon-menu span{ top: 6px; }
    .icon-menu::before{ top: 0; }
    .icon-menu::after{ bottom: 0; }

    /* ===== Single Chat View ===== */
    .chat{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      background: radial-gradient(900px 520px at 50% 0%, #f6f2ff 0%, #ffffff 58%, #f7f8fb 100%);
    }

    .chat-body{
      flex:1;
      min-height:0;
      overflow:auto;
      padding: 14px 14px 10px;
      scrollbar-width:none;
    }
    .chat-body::-webkit-scrollbar{ display:none; }

    /* ===== Home banner inside chat-body ===== */
    .home-banner{
      padding: 18px 8px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
    }

    .orb{
      width: 86px; height:86px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 25%,
        #ffffff 0%,
        #f5e7ff 20%,
        #b9a5ff 45%,
        #7c5cff 70%,
        #4c34e6 100%);
      box-shadow:
        0 0 0 12px rgba(109,94,252,0.08),
        0 22px 60px rgba(76, 52, 230, 0.22);
      position:relative;
      animation: orbFloat 3.8s ease-in-out infinite;
      margin-top: 6px;
      flex: 0 0 auto;
    }
    .orb::after{
      content:"";
      position:absolute;
      left:0; right:0;
      margin:auto;
      bottom:-18px;
      width: 78px; height: 20px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(15,23,42,0.22), transparent 68%);
      filter: blur(2px);
      opacity: .35;
      transform: scale(.9);
    }

    .home-title{
      font-size: 18px;
      font-weight: 900;
      text-align:center;
      margin-top: 6px;
    }

    /* ===== Quick actions (Ø«Ø§Ø¨Øª ÙÙˆÙ‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„) ===== */
    .quick-actions{
      flex: 0 0 auto;
      padding: 6px 10px 4px;
      background: linear-gradient(to top, #ffffff 70%, rgba(255,255,255,0.85));
      border-top: 1px solid var(--border);
    }
    .suggest-row{
      width:100%;
      display:flex;
      gap: 10px;
      justify-content:center;
      overflow-x:auto;
      padding: 6px 2px 2px;
      scrollbar-width:none;
    }
    .suggest-row::-webkit-scrollbar{ display:none; }

    .suggest-btn{
      flex: 0 0 auto;
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12.5px;
      color: var(--text);
      cursor:pointer;
      min-width: 150px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.04);
      transition: transform .12s ease, background .15s ease, border-color .15s ease;
      white-space: nowrap;
    }
    .suggest-btn:hover{ background:#fafbff; border-color:#dfe5f3; transform: translateY(-1px); }
    .suggest-btn:active{ transform: translateY(1px); }

    /* ===== Messages ===== */
    .message-group{
      margin-bottom: 10px;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }

    .msg{
      max-width: 86%;
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 13px;
      line-height: 1.7;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .msg.user{
      align-self:flex-end;
      background: linear-gradient(135deg, var(--p), var(--p2));
      color:#fff;
      border-bottom-left-radius: 6px;
    }

    .msg.assistant{
      align-self:flex-start;
      background:#fff;
      border:1px solid #edf0f7;
      box-shadow: 0 10px 30px rgba(15,23,42,0.05);
      border-bottom-right-radius: 6px;
    }

    /* ===== Footer / Input ===== */
    .chat-footer{
      padding: 10px 12px 12px;
      background:#fff;
      border-top: 0;
      flex: 0 0 auto;
    }

    .input-shell{
      position:relative;
      width:100%;
    }

    .chat-input{
      width:100%;
      resize:none;
      min-height: 46px;
      max-height: 110px;
      border-radius: 18px;
      border: 1px solid #e3e6f2;
      padding: 12px 14px 12px 56px;
      outline:none;
      font-family: inherit;
      font-size: 13px;
      line-height: 1.6;
      background:#fff;
      color: var(--text);
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .chat-input::placeholder{ color:#9aa4b2; }

    .state-default .chat-input{ border-color:#e3e6f2; box-shadow:none; }
    .state-enabled .chat-input{
      border-color: rgba(109,94,252,0.45);
      box-shadow: 0 0 0 3px rgba(109,94,252,0.12);
    }
    .state-filled .chat-input{
      border-color: rgba(109,94,252,0.55);
      box-shadow: 0 0 0 3px rgba(109,94,252,0.10);
    }

    .send-in{
      position:absolute;
      left: 10px;
      bottom: 8px;
      width: 38px;
      height: 38px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--p), var(--p2));
      box-shadow: 0 12px 28px rgba(109,94,252,0.28);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .12s ease, opacity .15s ease, box-shadow .15s ease;
    }
    .send-in:active{ transform: translateY(1px) scale(.98); box-shadow: 0 8px 20px rgba(109,94,252,0.20); }
    .send-in.disabled{ opacity: .35; cursor: default; box-shadow:none; }

    .arrow-up{
      width: 18px; height: 18px;
      position: relative;
      transform: translateY(-1px);
    }
    .arrow-up::before{
      content:"";
      position:absolute;
      left: 50%;
      top: 3px;
      width: 2px;
      height: 12px;
      background:#fff;
      transform: translateX(-50%);
      border-radius: 2px;
    }
    .arrow-up::after{
      content:"";
      position:absolute;
      left: 50%;
      top: 2px;
      width: 10px;
      height: 10px;
      border-top: 2px solid #fff;
      border-left: 2px solid #fff;
      transform: translateX(-50%) rotate(45deg);
      border-radius: 2px;
    }

    .brand-strip{
      text-align:center;
      padding: 8px 12px 12px;
      font-size: 11px;
      color: var(--muted2);
      background:#fff;
      border-top: 1px solid transparent;
      flex: 0 0 auto;
    }

    /* ===== Drawer (History) ===== */
    .drawer{
      position:absolute;
      inset:0;
      background:#fff;
      transform: translateX(100%);
      transition: transform .22s ease;
      display:flex;
      flex-direction:column;
      z-index: 50;
    }
    .drawer.open{ transform: translateX(0); }

    .drawer-top{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-bottom:1px solid var(--border);
      background:#fff;
      flex: 0 0 auto;
      gap: 8px;
    }

    .drawer-title{
      font-weight: 900;
      font-size: 16px;
      flex:1;
      text-align:center;
    }

    .new-chat{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-size: 12px;
      color: var(--text);
      box-shadow: 0 10px 30px rgba(15,23,42,0.04);
      transition: transform .12s ease, background .15s ease, border-color .15s ease;
      white-space: nowrap;
    }
    .new-chat:hover{ background:#fafbff; border-color:#dfe5f3; transform: translateY(-1px); }
    .new-chat:active{ transform: translateY(1px); }

    .hist{
      flex:1;
      min-height:0;
      overflow:auto;
      padding: 12px 12px 16px;
      background: radial-gradient(900px 520px at 50% 0%, #f6f2ff 0%, #ffffff 58%, #f7f8fb 100%);
      scrollbar-width:none;
    }
    .hist::-webkit-scrollbar{ display:none; }

    .hist-label{
      font-size: 12px;
      color: var(--muted2);
      font-weight: 800;
      margin: 12px 4px 8px;
    }

    .hist-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.04);
      margin-bottom: 10px;
      cursor:pointer;
    }
    .hist-item:hover{ border-color:#dfe5f3; background:#fff; }
    .hist-text{
      flex:1;
      font-size: 13px;
      color: var(--text);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .trash{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      cursor:pointer;
      color: var(--muted);
      transition: background .15s ease, border-color .15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
    }
    .trash:hover{ background:#f6f7fb; border-color:#eef0f6; }

    .empty-hist{
      margin-top: 40px;
      text-align:center;
      color: var(--muted);
      font-size: 13px;
    }

    @keyframes orbFloat{
      0%{ transform: translateY(0); }
      50%{ transform: translateY(-8px); }
      100%{ transform: translateY(0); }
    }

    @media (max-width: 520px){
      .page{ padding:0; align-items:stretch; }
      .app{
        max-width:none;
        min-height:100vh;
        max-height:none;
        border-radius:0;
        border-left:none;
        border-right:none;
        box-shadow:none;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="app">
      <!-- Topbar -->
      <header class="topbar">
        <div class="tb-spacer" aria-hidden="true"></div>

        <div class="tb-center">
          <div class="brand-icon">
            <!-- ØºÙŠÙ‘Ø±Ù‡Ø§ Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù†Ø³ÙŠÙ…/Ø§Ù„Ø¬Ù‡Ø© -->
            <img src="brand-icon.png" alt="Ø£ÙŠÙ‚ÙˆÙ†Ø©" />
          </div>
          <div class="brand-title">Ù…Ø³Ø§Ø¹Ø¯ Ù†Ø³ÙŠÙ…</div>
        </div>

        <button class="tb-btn" id="btnMenu" type="button" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
          <span class="icon-menu"><span></span></span>
        </button>
      </header>

      <!-- Single Chat View -->
      <section class="chat" id="chatView">
        <main class="chat-body" id="chatBody">
          <!-- Home banner (ÙŠØ®ØªÙÙŠ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø¥Ø±Ø³Ø§Ù„ Ø£Ùˆ Ø¹Ù†Ø¯ ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙŠÙ‡Ø§ Ø±Ø³Ø§Ø¦Ù„) -->
          <div class="home-banner" id="homeBanner">
            <div class="orb" aria-hidden="true"></div>
            <div class="home-title">ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>
          </div>

          <!-- optional small welcome -->
          <div class="message-group" id="welcomeMsg">
            <div class="msg assistant">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹\nØ§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ø¨Ø¯Ø¡.</div>
          </div>
        </main>

        <!-- Quick Actions Ø«Ø§Ø¨Øª -->
        <div class="quick-actions" id="quickActions">
          <div class="suggest-row" id="suggestRow">
            <button class="suggest-btn" data-text="Ø£Ø¨ÙŠ Ø£Ø¹Ø±Ù ØªÙØ§ØµÙŠÙ„ Ø®Ø¯Ù…Ø© Ù…Ø¹ÙŠÙ†Ø©">Ø£Ø¨ÙŠ Ø£Ø¹Ø±Ù ØªÙØ§ØµÙŠÙ„ Ø®Ø¯Ù…Ø© Ù…Ø¹ÙŠÙ†Ø©</button>
            <button class="suggest-btn" data-text="Ø³Ø§Ø¹Ø¯Ù†ÙŠ Ø£Ù„Ù‚ÙŠ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨">Ø³Ø§Ø¹Ø¯Ù†ÙŠ Ø£Ù„Ù‚ÙŠ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨</button>
            <button class="suggest-btn" data-text="Ø¹Ù†Ø¯ÙŠ Ø³Ø¤Ø§Ù„ Ø¹Ù† Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø±ØµØ¯ ÙˆØ§Ù„Ø±Ù‚Ø§Ø¨Ø©">Ø¹Ù†Ø¯ÙŠ Ø³Ø¤Ø§Ù„ Ø¹Ù† Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø±ØµØ¯ ÙˆØ§Ù„Ø±Ù‚Ø§Ø¨Ø©</button>
          </div>
        </div>

        <!-- Input Ø«Ø§Ø¨Øª -->
        <footer class="chat-footer">
          <div class="input-shell state-default" id="inputState">
            <textarea id="chatInput" class="chat-input" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."></textarea>
            <button id="sendBtn" class="send-in disabled" type="button" aria-label="Ø¥Ø±Ø³Ø§Ù„">
              <span class="arrow-up"></span>
            </button>
          </div>
        </footer>

        <div class="brand-strip">Ù…Ø¯Ø¹ÙˆÙ… Ù…Ù† Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ÙˆØ·Ù†ÙŠ Ù„Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„ØªÙØªÙŠØ´ ÙˆØ§Ù„Ø±Ù‚Ø§Ø¨Ø©</div>
      </section>

      <!-- History Drawer -->
      <aside class="drawer" id="historyDrawer" aria-label="Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª">
        <div class="drawer-top">
          <!-- Ø²Ø± Ø±Ø¬ÙˆØ¹/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¬ -->
          <button class="tb-btn" id="btnCloseDrawer" type="button" aria-label="Ø±Ø¬ÙˆØ¹">â†</button>

          <div class="drawer-title">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>

          <button class="new-chat" id="btnNewChat" type="button">Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        </div>

        <div class="hist" id="historyList"></div>
        <div class="brand-strip">Ù…Ø¯Ø¹ÙˆÙ… Ù…Ù† Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ÙˆØ·Ù†ÙŠ Ù„Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„ØªÙØªÙŠØ´ ÙˆØ§Ù„Ø±Ù‚Ø§Ø¨Ø©</div>
      </aside>
    </div>
  </div>

  <script>
    /* ===========================
       CONFIG
    ============================ */
    const API_URL = "/api/chat";
    const LS_KEY = "nasim_conversations";
    const LS_ACTIVE = "nasim_active_conversation_id";

    /* ===========================
       STATE
    ============================ */
    let conversations = loadConversations();
    let activeConvId = localStorage.getItem(LS_ACTIVE) || null;
    let loadingBubble = null;

    /* ===========================
       ELEMENTS
    ============================ */
    const btnMenu = document.getElementById("btnMenu");
    const historyDrawer = document.getElementById("historyDrawer");
    const historyList = document.getElementById("historyList");
    const btnNewChat = document.getElementById("btnNewChat");
    const btnCloseDrawer = document.getElementById("btnCloseDrawer");

    const chatBody = document.getElementById("chatBody");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const inputState = document.getElementById("inputState");
    const suggestRow = document.getElementById("suggestRow");

    const homeBanner = document.getElementById("homeBanner");
    const welcomeMsg = document.getElementById("welcomeMsg");

    /* ===========================
       UTIL
    ============================ */
    function nowISO(){ return new Date().toISOString(); }

    function loadConversations(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }

    function saveConversations(){
      localStorage.setItem(LS_KEY, JSON.stringify(conversations));
    }

    function uuid(){
      return "c_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function scrollToBottom(){
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function setSendEnabled(enabled){
      if(enabled) sendBtn.classList.remove("disabled");
      else sendBtn.classList.add("disabled");
    }

    function setInputVisualState(state){
      inputState.classList.remove("state-default","state-enabled","state-filled");
      inputState.classList.add(state);
    }

    function getActiveConversation(){
      if(!activeConvId) return null;
      return conversations.find(c => c.id === activeConvId) || null;
    }

    /* ===========================
       SMART TITLE (Ù…Ø®ØªØµØ±)
    ============================ */
    function smartTitleFrom(text){
      let s = (text || "").trim();
      s = s.replace(/[ØŸ?!.ØŒØ›:]+/g, " ").replace(/\s+/g, " ").trim();

      const removePrefixes = [
        "ÙƒÙŠÙ", "ÙˆØ´", "Ù…Ø§", "Ù…Ø§Ù‡Ùˆ", "Ù…Ø§ Ù‡Ùˆ", "Ø£Ø¨ÙŠ", "Ø§Ø¨ÙŠ", "Ø£Ø±ÙŠØ¯", "Ø§Ø±ÙŠØ¯",
        "Ù…Ù…ÙƒÙ†", "Ù„Ùˆ Ø³Ù…Ø­Øª", "Ø³Ø§Ø¹Ø¯Ù†ÙŠ", "Ø³Ø§Ø¹Ø¯", "Ø£Ø±Ø´Ø¯Ù†ÙŠ", "Ø§Ø±Ø´Ø¯Ù†ÙŠ",
        "Ø¹Ù†Ø¯ÙŠ", "Ù‡Ù„", "ÙˆÙŠÙ†", "ÙˆØ´ Ù‡ÙŠ", "Ù…Ø§ Ù‡ÙŠ", "Ø§Ø¨ÙŠ Ø§Ø¹Ø±Ù", "Ø£Ø¨ÙŠ Ø£Ø¹Ø±Ù"
      ];

      for(const p of removePrefixes){
        if(s.startsWith(p + " ")){ s = s.slice(p.length).trim(); break; }
      }

      const stop = new Set(["Ø¹Ù†","ÙÙŠ","Ø¹Ù„Ù‰","Ù…Ù†","Ø¥Ù„Ù‰","Ø§Ù„Ù‰","Ù‡Ø°Ø§","Ù‡Ø°Ù‡","Ø°Ù„Ùƒ","ØªÙ„Ùƒ","Ù‡Ùˆ","Ù‡ÙŠ","Ø§Ù†Ø§","Ø£Ù†Ø§","Ù„Ù€","Ø¨Ù€","Ùˆ"]);
      const words = s.split(" ").filter(w => w && !stop.has(w));
      const pick = words.length ? words : (s ? s.split(" ") : []);
      return (pick.slice(0, 5).join(" ") || "Ù…Ø­Ø§Ø¯Ø«Ø©");
    }

    /* ===========================
       HOME BANNER VISIBILITY
    ============================ */
    function showHomeBanner(){
      if(homeBanner) homeBanner.style.display = "flex";
      if(welcomeMsg) welcomeMsg.style.display = "block";
    }

    function hideHomeBanner(){
      if(homeBanner) homeBanner.style.display = "none";
      if(welcomeMsg) welcomeMsg.style.display = "none";
    }

    /* ===========================
       UI RENDER
    ============================ */
    function addMessage(text, sender="assistant"){
      const group = document.createElement("div");
      group.className = "message-group";
      const msg = document.createElement("div");
      msg.className = "msg " + (sender === "user" ? "user" : "assistant");
      msg.innerText = text;
      group.appendChild(msg);
      chatBody.appendChild(group);
      setTimeout(scrollToBottom, 20);
    }

    function addLoadingBubble(){
      if(loadingBubble) return;
      const group = document.createElement("div");
      group.className = "message-group";
      const msg = document.createElement("div");
      msg.className = "msg assistant";
      msg.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.";
      group.appendChild(msg);
      chatBody.appendChild(group);
      loadingBubble = group;
      setTimeout(scrollToBottom, 20);
    }

    function removeLoadingBubble(){
      if(loadingBubble && loadingBubble.parentNode){
        loadingBubble.parentNode.removeChild(loadingBubble);
      }
      loadingBubble = null;
      setTimeout(scrollToBottom, 20);
    }

    function clearRenderedMessagesKeepBanner(){
      const keep = new Set([homeBanner, welcomeMsg]);
      [...chatBody.children].forEach(ch => { if(!keep.has(ch)) ch.remove(); });
    }

    function renderChat(conv){
      clearRenderedMessagesKeepBanner();

      if(!conv || !Array.isArray(conv.messages)) {
        showHomeBanner();
        return;
      }

      if(conv.messages.length > 0) hideHomeBanner();
      else showHomeBanner();

      for(const m of conv.messages){
        addMessage(m.text, m.role);
      }
      setTimeout(scrollToBottom, 20);
    }

    /* ===========================
       HISTORY (Ø§Ù„ÙŠÙˆÙ… / Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ)
    ============================ */
    function isSameDay(d1, d2){
      return d1.getFullYear() === d2.getFullYear()
        && d1.getMonth() === d2.getMonth()
        && d1.getDate() === d2.getDate();
    }

    function groupConversations(){
      const now = new Date();
      const today = [];
      const week = [];
      const sorted = [...conversations].sort((x,y) => (y.updatedAt || "").localeCompare(x.updatedAt || ""));
      for(const c of sorted){
        const t = new Date(c.updatedAt || c.createdAt || nowISO());
        if(isSameDay(t, now)) today.push(c);
        else week.push(c);
      }
      return { today, week };
    }

    function renderHistory(){
      const { today, week } = groupConversations();
      historyList.innerHTML = "";

      if(conversations.length === 0){
        const empty = document.createElement("div");
        empty.className = "empty-hist";
        empty.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯.";
        historyList.appendChild(empty);
        return;
      }

      const makeSection = (label, items) => {
        const lbl = document.createElement("div");
        lbl.className = "hist-label";
        lbl.innerText = label;
        historyList.appendChild(lbl);

        if(items.length === 0){
          const em = document.createElement("div");
          em.className = "empty-hist";
          em.style.marginTop = "10px";
          em.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.";
          historyList.appendChild(em);
          return;
        }

        for(const c of items){
          const row = document.createElement("div");
          row.className = "hist-item";

          // highlight current
          if(c.id === activeConvId){
            row.style.borderColor = "rgba(109,94,252,.55)";
          }

          const t = document.createElement("div");
          t.className = "hist-text";
          t.innerText = c.title || "Ù…Ø­Ø§Ø¯Ø«Ø©";
          row.appendChild(t);

          const trash = document.createElement("button");
          trash.className = "trash";
          trash.type = "button";
          trash.setAttribute("aria-label","Ø­Ø°Ù");
          trash.textContent = "ğŸ—‘ï¸";
          row.appendChild(trash);

          row.addEventListener("click", (e) => {
            if(e.target === trash) return;
            activeConvId = c.id;
            localStorage.setItem(LS_ACTIVE, activeConvId);
            closeDrawer();
            renderChat(c);
          });

          trash.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            deleteConversation(c.id);
          });

          historyList.appendChild(row);
        }
      };

      makeSection("Ø§Ù„ÙŠÙˆÙ…", today);
      makeSection("Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ", week);
    }

    function deleteConversation(id){
      conversations = conversations.filter(c => c.id !== id);
      saveConversations();

      if(activeConvId === id){
        activeConvId = null;
        localStorage.removeItem(LS_ACTIVE);
        showHomeBanner();
        clearRenderedMessagesKeepBanner();
      }
      renderHistory();
    }

    /* ===========================
       CONVERSATION CONTROL
    ============================ */
    function startNewConversation(){
      activeConvId = null;
      localStorage.removeItem(LS_ACTIVE);

      showHomeBanner();
      clearRenderedMessagesKeepBanner();

      chatInput.value = "";
      chatInput.style.height = "46px";
      setSendEnabled(false);
      setInputVisualState("state-default");
    }

    function ensureConversationExists(firstUserText){
      let conv = getActiveConversation();
      if(conv) return conv;

      const id = uuid();
      const createdAt = nowISO();
      conv = {
        id,
        title: smartTitleFrom(firstUserText),
        createdAt,
        updatedAt: createdAt,
        threadId: null,
        messages: []
      };

      conversations.unshift(conv);
      saveConversations();

      activeConvId = id;
      localStorage.setItem(LS_ACTIVE, activeConvId);

      return conv;
    }

    function pushMessageToConv(conv, role, text){
      conv.messages.push({ role, text, ts: nowISO() });
      conv.updatedAt = nowISO();

      if(!conv.title || conv.title === "Ù…Ø­Ø§Ø¯Ø«Ø©"){
        if(role === "user") conv.title = smartTitleFrom(text);
      }

      saveConversations();
    }

    /* ===========================
       API
    ============================ */
    async function callAssistantAPI(conv, userText){
      addLoadingBubble();
      try{
        const resp = await fetch(API_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            message: userText,
            threadId: conv.threadId
          })
        });

        if(!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        conv.threadId = data.threadId || conv.threadId;

        removeLoadingBubble();

        const answer = data.answer || "Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙØªØ§Ø­ answer ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©.";
        addMessage(answer, "assistant");
        pushMessageToConv(conv, "assistant", answer);

        renderHistory();
      }catch(err){
        console.error("API error:", err);
        removeLoadingBubble();
        const msg = "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©.\nØªØ£ÙƒØ¯ Ø£Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ù…ØªØ§Ø­Ø© Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
        addMessage(msg, "assistant");
        pushMessageToConv(conv, "assistant", msg);
        renderHistory();
      }
    }

    function handleSend(){
      const text = chatInput.value.trim();
      if(!text || sendBtn.classList.contains("disabled")) return;

      hideHomeBanner();

      const conv = ensureConversationExists(text);

      addMessage(text, "user");
      pushMessageToConv(conv, "user", text);

      chatInput.value = "";
      chatInput.style.height = "46px";
      setSendEnabled(false);
      setInputVisualState("state-default");

      renderHistory();
      callAssistantAPI(conv, text);
    }

    /* ===========================
       DRAWER CONTROL (ÙŠØ±Ø¬Ø¹ Ø¨Ø¯ÙˆÙ† ØªØµÙÙŠØ±)
    ============================ */
    function openDrawer(){
      renderHistory();
      historyDrawer.classList.add("open");
    }
    function closeDrawer(){
      historyDrawer.classList.remove("open");
    }

    /* ===========================
       EVENTS
    ============================ */
    btnMenu.addEventListener("click", openDrawer);
    btnCloseDrawer.addEventListener("click", closeDrawer);

    // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªØµÙÙŠØ±)
    historyDrawer.addEventListener("click", (e) => {
      if(e.target === historyDrawer) closeDrawer();
    });

    btnNewChat.addEventListener("click", () => {
      closeDrawer();
      startNewConversation();
    });

    suggestRow.addEventListener("click", (e) => {
      const b = e.target.closest(".suggest-btn");
      if(!b) return;
      const t = b.getAttribute("data-text") || b.innerText;
      chatInput.value = t;
      chatInput.dispatchEvent(new Event("input"));
      chatInput.focus();
      handleSend();
    });

    chatInput.addEventListener("focus", () => {
      setInputVisualState(chatInput.value.trim() ? "state-filled" : "state-enabled");
    });

    chatInput.addEventListener("blur", () => {
      setInputVisualState(chatInput.value.trim() ? "state-filled" : "state-default");
    });

    chatInput.addEventListener("input", () => {
      const has = chatInput.value.trim().length > 0;
      setSendEnabled(has);
      setInputVisualState(has ? "state-filled" : (document.activeElement === chatInput ? "state-enabled" : "state-default"));

      chatInput.style.height = "auto";
      chatInput.style.height = Math.min(chatInput.scrollHeight, 110) + "px";
    });

    chatInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        handleSend();
      }
    });

    sendBtn.addEventListener("click", handleSend);

    /* ===========================
       INIT
    ============================ */
    window.addEventListener("load", () => {
      setSendEnabled(false);
      setInputVisualState("state-default");

      const conv = getActiveConversation();
      if(conv){
        renderChat(conv);
      }else{
        showHomeBanner();
        clearRenderedMessagesKeepBanner();
      }

      setTimeout(scrollToBottom, 50);
    });
  </script>
</body>
</html>
